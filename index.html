<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Basic page metadata -->
  <meta charset="UTF-8" />
  <title>Braze Web SDK SEL Sandbox</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="shortcut icon" href="#" />

  <!-- Simple styling to make the sandbox readable and demo-friendly -->
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f7f9;
      padding: 40px;
      text-align: center;
    }
    .container {
      background: #ffffff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: inline-block;
      min-width: 320px;
    }
    button {
      width: 220px;
      margin: 10px auto;
      padding: 12px;
      cursor: pointer;
      background-color: #0073eb;
      color: #ffffff;
      border: none;
      border-radius: 4px;
      font-weight: bold;
      font-size: 14px;
    }
    button:hover {
      background-color: #005bbd;
    }
    .status {
      margin-top: 15px;
      font-size: 13px;
      color: #555;
    }
  </style>

  <!--
    Braze Web SDK Loader (Asynchronous)
    ----------------------------------
    This snippet creates a temporary queue so Braze API calls can be made
    before the SDK finishes loading. Once loaded, the SDK processes the queue.

    This is the recommended integration pattern from Braze docs.
  -->
  <script type="text/javascript">
    +function(a,p,P,b,y){
      a.braze={};
      a.brazeQueue=[];

      // Define the Braze methods we will use in this sandbox
      for(var s="initialize openSession changeUser logCustomEvent automaticallyShowInAppMessages getUser requestImmediateDataFlush toggleLogging".split(" "),i=0;i<s.length;i++){
        a.braze[s[i]]=function(){a.brazeQueue.push(arguments);}
      }

      // Load the Braze SDK from the CDN
      (y=p.createElement(P)).type='text/javascript';
      y.src='https://js.appboycdn.com/web-sdk/6.5/braze.min.js';
      y.async=1;
      (b=p.getElementsByTagName(P)[0]).parentNode.insertBefore(y,b);
    }(window,document,'script');
  </script>
</head>

<body>

  <!-- Simple UI for triggering SDK behavior -->
  <div class="container">
    <h1>Braze SEL Sandbox</h1>
    <p class="status">Open DevTools Console to view SDK logs</p>

    <button onclick="startBraze()">1. Start Braze Session</button>
    <button onclick="loginUser()">2. Login & Identify User</button>
    <button onclick="triggerEvent()">3. Trigger Engagement (IAM)</button>
  </div>

  <script>
    /*
      This flag ensures that the Braze SDK is initialized only once.
      Re-initializing the SDK can cause configuration options (such as
      allowUserSuppliedJavascript) to be ignored.
    */
    let brazeInitialized = false;

    /*
      1. SDK Initialization
      ---------------------
      - Initializes the Braze Web SDK
      - Opens a new session
      - Enables automatic rendering of In-App Messages
      - Enables HTML In-App Messages for this sandbox
    */
    function startBraze() {
      if (brazeInitialized) {
        console.log("Braze already initialized");
        return;
      }

      braze.initialize("88884959-92fe-4bd7-ab6b-6660b1c9e859", {
        baseUrl: "sondheim.braze.com",
        enableLogging: true,                 // Enables console logs for debugging
        allowUserSuppliedJavascript: true    // Required for HTML In-App Messages
      });

      // Automatically display any In-App Messages received
      braze.automaticallyShowInAppMessages();

      // Open a Braze session (should be called after initialize)
      braze.openSession();

      // Enable verbose logging after initialization
      braze.toggleLogging();

      brazeInitialized = true;

      console.log("Braze initialized and session started");
      alert("Braze initialized successfully");
    }

    /*
      2. User Identification
      ----------------------
      - Demonstrates use of changeUser()
      - Assigns a unique external user ID
      - Sets basic user attributes
      - Flushes data immediately to Braze
    */
    function loginUser() {
      if (!brazeInitialized) {
        alert("Initialize Braze first");
        return;
      }

      // Generate a unique test user ID
      const userId = "SEL_TEST_" + Date.now();

      // Associate the session with a known user
      braze.changeUser(userId);

      // Set sample user attributes
      braze.getUser().setFirstName("BrazeSEL");
      braze.getUser().setEmail(userId + "@example.com");

      // Immediately send data to Braze for verification
      braze.requestImmediateDataFlush();

      console.log("User identified as:", userId);
      alert("User logged in:\n" + userId);
    }

    /*
      3. Engagement Test
      ------------------
      - Logs a custom event
      - Used to trigger an In-App Message campaign
      - The message will appear on this webpage
    */
    function triggerEvent() {
      if (!brazeInitialized) {
        alert("Initialize Braze first");
        return;
      }

      // Log a custom event used as a campaign trigger
      braze.logCustomEvent("web_sdk_test_event");

      // Immediately flush the event to Braze
      braze.requestImmediateDataFlush();

      console.log("Custom event logged: web_sdk_test_event");
      alert("Event logged â€” IAM should appear now");
    }
  </script>

</body>
</html>
