<!DOCTYPE html>
<html lang="en">
<head>
  <!-- =========================================================
       BASIC PAGE METADATA
       ========================================================= -->
  <meta charset="UTF-8" />
  <title>Braze Web SDK SEL Sandbox</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="shortcut icon" href="#" />

  <!-- =========================================================
       SIMPLE STYLING FOR DEMO PURPOSES
       ========================================================= -->
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f7f9;
      padding: 40px;
      text-align: center;
    }
    .container {
      background: #ffffff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: inline-block;
      min-width: 320px;
    }
    button {
      width: 240px;
      margin: 10px auto;
      padding: 12px;
      cursor: pointer;
      background-color: #0073eb;
      color: #ffffff;
      border: none;
      border-radius: 4px;
      font-weight: bold;
      font-size: 14px;
    }
    button:hover {
      background-color: #005bbd;
    }
    .status {
      margin-top: 15px;
      font-size: 13px;
      color: #555;
    }
  </style>

  <!-- =========================================================
       BRAZE WEB SDK LOADER (ASYNC + QUEUE)
       =========================================================
       - Creates a temporary queue so Braze methods can be called
         before the SDK finishes loading
       - Once loaded, the SDK processes the queued calls
       - This is Braze's recommended integration pattern
  -->
  <script>
    +function(w,d,s){
      w.braze = {};
      w.brazeQueue = [];

      const methods = [
        "initialize",
        "openSession",
        "changeUser",
        "logCustomEvent",
        "automaticallyShowInAppMessages",
        "getUser",
        "requestImmediateDataFlush",
        "requestPushPermission",
        "isPushSupported",
        "isPushPermissionGranted"
      ];

      methods.forEach(method => {
        w.braze[method] = function () {
          w.brazeQueue.push([method, arguments]);
        };
      });

      const script = d.createElement(s);
      script.async = true;
      script.src = "https://js.appboycdn.com/web-sdk/6.5/braze.min.js";
      d.head.appendChild(script);
    }(window, document, "script"));
  </script>
</head>

<body>

  <!-- =========================================================
       DEMO UI
       ========================================================= -->
  <div class="container">
    <h1>Braze SEL Sandbox</h1>
    <p class="status">Open DevTools → Console & Application tabs</p>

    <button onclick="startBraze()">1. Initialize Braze</button>
    <button onclick="loginUser()">2. Identify User</button>
    <button onclick="triggerEvent()">3. Trigger IAM</button>
    <button onclick="enablePush()">4. Enable Web Push</button>
  </div>

  <!-- =========================================================
       BRAZE SANDBOX LOGIC
       ========================================================= -->
  <script>
    // Prevents accidental re-initialization
    let brazeInitialized = false;

    /*
      -----------------------------------------------------------
      1. INITIALIZE BRAZE SDK
      -----------------------------------------------------------
      - Initializes SDK
      - Opens session
      - Enables IAM auto-rendering
      - Enables HTML IAMs
      - Declares external service worker management
    */
    function startBraze() {
      if (brazeInitialized) return;

      braze.initialize("88884959-92fe-4bd7-ab6b-6660b1c9e859", {
        baseUrl: "sondheim.braze.com",
        enableLogging: true,
        allowUserSuppliedJavascript: true,
        manageServiceWorkerExternally: true // REQUIRED for Web Push
      });

      braze.automaticallyShowInAppMessages();
      braze.openSession();
      brazeInitialized = true;

      console.log("Braze initialized");
      alert("Braze initialized successfully");
    }

    /*
      -----------------------------------------------------------
      2. IDENTIFY USER
      -----------------------------------------------------------
      - Assigns a unique external_id
      - Sets sample attributes
      - Flushes immediately for dashboard visibility
    */
    function loginUser() {
      if (!brazeInitialized) {
        alert("Initialize Braze first");
        return;
      }

      const userId = "SEL_TEST_" + Date.now();

      braze.changeUser(userId);
      braze.getUser().setFirstName("Braze");
      braze.getUser().setLastName("SEL");
      braze.getUser().setEmail(userId + "@example.com");

      braze.requestImmediateDataFlush();

      console.log("User identified:", userId);
      alert("User identified:\n" + userId);
    }

    /*
      -----------------------------------------------------------
      3. TRIGGER CUSTOM EVENT (IAM)
      -----------------------------------------------------------
      - Logs custom event
      - Used as IAM campaign trigger
      - IAM renders directly on this page
    */
    function triggerEvent() {
      if (!brazeInitialized) {
        alert("Initialize Braze first");
        return;
      }

      braze.logCustomEvent("web_sdk_test_event");
      braze.requestImmediateDataFlush();

      console.log("Custom event logged");
      alert("Event logged — IAM should appear");
    }

    /*
      -----------------------------------------------------------
      4. ENABLE WEB PUSH
      -----------------------------------------------------------
      - Checks browser support
      - Requests permission
      - Verifies full Braze registration
    */
    function enablePush() {
      if (!brazeInitialized) {
        alert("Initialize Braze first");
        return;
      }

      if (!braze.isPushSupported()) {
        alert("Web Push not supported in this browser");
        return;
      }

      braze.requestPushPermission(
        () => {
          // Delay check to allow service worker registration
          setTimeout(() => {
            const registered = braze.isPushPermissionGranted();
            console.log("Push fully registered:", registered);
            alert(
              registered
                ? "Push fully registered with Braze!"
                : "Permission granted, but registration failed. Check Service Worker."
            );
          }, 1000);
        },
        (error) => {
          console.error("Push registration error:", error);
          alert("Push registration failed — see console");
        }
      );
    }
  </script>

</body>
</html>
